# Generated from .gitlab-ci.jsonnet
#     DO NOT EDIT THIS FILE BY HAND -- YOUR CHANGES WILL BE OVERWRITTEN
---
container-base-build:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  image: docker:git
  only:
  - master
  - tags
  script:
  - docker build --cache-from quay.io/quay/quay-base:latest -t quay.io/quay/quay-ci:latest -f quay-base.dockerfile .
  - docker push quay.io/quay/quay-ci:latest
  services:
  - docker:dind
  stage: bad_stage
  tags:
  - docker
  variables:
    DOCKER_DRIVER: aufs
container-base-build-branch:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  image: docker:git
  only:
  - branches
  script:
  - docker build --cache-from quay.io/quay/quay-base:latest -t quay.io/quay/quay-ci:latest -f quay-base.dockerfile .
  - docker push quay.io/quay/quay-ci:latest
  services:
  - docker:dind
  stage: docker_build
  tags:
  - docker
  variables:
    DOCKER_DRIVER: aufs
  when: manual
container-build:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  image: docker:git
  only:
  - branches
  script:
  - docker build -t quay.io/quay/quay-ci:${CI_COMMIT_REF_SLUG} -f quay.dockerfile .
  - docker push quay.io/quay/quay-ci:${CI_COMMIT_REF_SLUG}
  - docker tag quay.io/quay/quay-ci:${CI_COMMIT_REF_SLUG} quay.io/quay/quay-ci:${CI_COMMIT_SHA}
  - docker push quay.io/quay/quay-ci:${CI_COMMIT_SHA}
  services:
  - docker:dind
  stage: docker_build
  tags:
  - docker
  variables:
    DOCKER_DRIVER: aufs
container-build-branch:
  before_script:
  - docker login -u $DOCKER_USER -p $DOCKER_PASS quay.io
  image: docker:git
  only:
  - master, tags
  script:
  - docker build -t quay.io/quay/quay-ci:${CI_COMMIT_REF_SLUG} -f quay.dockerfile .
  - docker push quay.io/quay/quay-ci:${CI_COMMIT_REF_SLUG}
  services:
  - docker:dind
  stage: docker_build
  tags:
  - docker
  variables:
    DOCKER_DRIVER: aufs
karma-tests:
  before_script:
  - cd /
  - source venv/bin/activate
  script:
  - yarn test
  stage: unit_tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
mysql:
  before_script:
  - cd /
  - source venv/bin/activate
  script:
  - sleep 30
  - alembic upgrade head
  - PYTHONPATH="." TEST="true" py.test --timeout=7200 --verbose --show-count ./ --color=no --ignore=endpoints/appr/test/ -x
  services:
  - mysql:latest
  stage: integration
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
    MYSQL_DATABASE: quay
    MYSQL_PASSWORD: quay
    MYSQL_ROOT_PASSWORD: quay
    MYSQL_USER: quay
    SKIP_DB_SCHEMA: 'true'
    TEST_DATABASE_URI: mysql+pymysql://quay:quay@localhost/quay
postgres:
  before_script:
  - cd /
  - source venv/bin/activate
  script:
  - sleep 30
  - alembic upgrade head
  - PYTHONPATH="." TEST="true" py.test --timeout=7200 --verbose --show-count ./ --color=no --ignore=endpoints/appr/test/ -x
  services:
  - postgres:9.6
  stage: integration
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
    POSTGRES_PASSWORD: quay
    POSTGRES_USER: quay
    SKIP_DB_SCHEMA: 'true'
    TEST_DATABASE_URI: postgresql://quay:quay@localhost/quay
registry-tests:
  before_script:
  - cd /
  - source venv/bin/activate
  script:
  - py.test --timeout=7200 --verbose --show-count ./test/registry_tests.py --color=no -x
  stage: unit_tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
stages:
- docker_build
- unit_tests
- integration
unit-tests:
  before_script:
  - cd /
  - source venv/bin/activate
  script:
  - py.test --timeout=7200 --verbose --show-count ./ --color=no -x
  stage: unit_tests
  tags:
  - kubernetes
  variables:
    GIT_STRATEGY: none
variables:
  FAILFASTCI_NAMESPACE: quay
